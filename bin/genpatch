#!/bin/sh 
# $Header:$
# gen autoexec patch file

getScriptPath () {
  echo ${0%/*}/
}

source $(getScriptPath)/common.sh;

if [ -z "$AE_SANDBOX_PATH" ]
then
    echo "ae_init_sandbox not performed, impossible to detect risks!!!";
    exit -1;
fi;

ORIG=$MYSBOX;
DEST=$AE_SANDBOX_PATH;

if [ ! -f "$1"  ];
then
    echo $1 "doesnt exist";
    exit -1;
fi;

PATCH=$(getfile);
echo "#!/bin/sh " >> $PATCH;
cat >> $PATCH << EOF
#!/bin/sh -eu

PATCH=\$1
OUTDIR=\$2

test -f "\$PATCH" && test -d "\$OUTDIR"

TDIR=\$(mktemp -d)
trap 'rm -rf \$TDIR' 0

INDEX=0
TEMPHUNK=\$TDIR/current_hunk

lsdiff \$1 | while read FNAME
do
    HUNK=1
    while :
    do
        filterdiff --annotate --hunks=\$HUNK -i "\$FNAME" "\$PATCH" > "\$TEMPHUNK"
        HUNK=\$((HUNK+1))
        test -s "\$TEMPHUNK" && \
            {
                mv "\$TEMPHUNK" "\$OUTDIR/\$INDEX.diff"
                INDEX=\$((INDEX+1))
            } || break
    done
done
EOF
echo "cat > /tmp/patch.gz << EOF" >> $PATCH;
gzip -c $1|xxd -p >> $PATCH;
echo "EOF" >> $PATCH;
echo "xxd -p -r /tmp/patch.gz|gzip -dc > /tmp/patch" >> $PATCH;
echo "patch -p0 -i /tmp/patch;" >> $PATCH;
echo "exit 0;" >> $PATCH;

mv $PATCH $1.patch.sh;
chmod +x $1.patch.sh;

exit 0;
