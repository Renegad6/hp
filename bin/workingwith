#!/bin/sh
# $Header:$
# check de impresora por cambio de IP.
#...

getScriptPath () {
  echo ${0%/*}/
}

source $(getScriptPath)/common.sh;

if [ -z "$AE_SANDBOX_PATH" ]
then
    echo "ae_init_sandbox not performed, impossible to detect risks!!!";
    exit -1;
fi;

. ${AE_SANDBOX_PATH}/externals/aenv/scripts/loadSetupNew

reset () {
#reset 
    grep -v $IP ~/workingwith.data > /tmp/workingwith.data.new;
    mv /tmp/workingwith.data.new ~/workingwith.data;
}

check () {
#check
    grep $IP ~/workingwith.data|cut -f2- -d: > /tmp/ww.1;
    (ssh root@$IP grep \"^PrinterConfigurator:.*Framework to boot\" /tmp/printer.log) > /tmp/ww.2;
    cmp /tmp/ww.1 /tmp/ww.2 > /dev/null 2>&1;
    if test ! $? -eq 0
    then
        echo "WORKINGWITH CHECK1 failed!!!!!!!";
        echo "WORKINGWITH CHECK1 failed!!!!!!!";
        echo "WORKINGWITH CHECK1 failed!!!!!!!";
        echo "WORKINGWITH CHECK1 failed!!!!!!!";
        echo "WORKINGWITH CHECK1 failed!!!!!!!";
        echo "local:";cat /tmp/ww.1;
        echo "remote:";cat /tmp/ww.2;
        exit -1;
    fi;
}
check2 () {
    PRODUCT=$(cat ${PRODUCT_TARGET_ROOT}/configure.product);
    (ssh root@$IP grep \"^PrinterConfigurator:.*Framework to boot\" /tmp/printer.log) > /tmp/ww.2;
    grep $PRODUCT /tmp/ww.2 > /dev/null 2>&1;
    if test ! $? -eq 0
    then
        echo "WORKINGWITH CHECK2 failed!!!!!!!";
        echo "WORKINGWITH CHECK2 failed!!!!!!!";
        echo "WORKINGWITH CHECK2 failed!!!!!!!";
        echo "WORKINGWITH CHECK2 failed!!!!!!!";
        echo "WORKINGWITH CHECK2 failed!!!!!!!";
        echo "product:";echo $PRODUCT;
        echo "remote:";cat /tmp/ww.2;
        exit -1;
    fi;
}

add () {
    DATA=$(ssh root@$IP grep \"^PrinterConfigurator:.*Framework to boot\" /tmp/printer.log);
    echo $IP:$DATA >> ~/workingwith.data;
    echo $DATA;
}

if test "$1" = "-r"
then
    IP=$(cat ~/workingwith.ip);
    reset;
elif test ! -z "$1"
then
    IP=$1;
    echo $IP > ~/workingwith.ip;
    grep $1 ~/workingwith.data > /dev/null 2>&1;
    if test $? -eq 0
    then
        check;
        check2;
    else
        add;
        check2;
    fi;
elif test -f ~/workingwith.data
then
    IP=$(cat ~/workingwith.ip);
    check;
    check2;
else
    echo "workingwith.data, not found! set first!";
    exit -1;
fi;
